<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Antigüedades de Santa Emilia</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Raleway:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #795548;
            --primary-dark: #5D4037;
            --primary-light: #D7CCC8;
            --accent: #BF9E7B;
            --accent-hover: #A1887F;
            --text: #3E2723;
            --text-light: #8D6E63;
            --bg: #F5F5F5;
            --card: #FFFFFF;
            --error: #B71C1C;
            --success: #2E7D32;
            --warning: #F57F17;
            --info: #0277BD;
        }
        body {
            font-family: 'Raleway', sans-serif;
            color: var(--text);
            background-color: var(--bg);
        }
        h1, h2, h3, h4, h5 {
            font-family: 'Playfair Display', serif;
        }
        .btn {
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .dropzone {
            border: 2px dashed var(--primary-light);
            transition: all 0.3s;
        }
        .dropzone:hover, .dropzone.dragover {
            border-color: var(--accent);
            background-color: rgba(191, 158, 123, 0.1);
        }
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        .custom-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .image-preview {
            height: 200px;
            position: relative;
        }
        .image-preview img {
            height: 100%;
            object-fit: cover;
        }
        .image-preview .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(183, 28, 28, 0.8);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .best-image-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(46, 125, 50, 0.8);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .progress-bar {
            height: 10px;
            background-color: var(--primary-light);
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }
        .spinner {
            border-radius: 50%;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(189, 189, 189, 0.25);
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .portfolio-item {
            transition: all 0.3s;
        }
        .portfolio-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        .portfolio-item-image {
            height: 200px;
            overflow: hidden;
        }
        .portfolio-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .portfolio-item:hover .portfolio-item-image img {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-primary py-4 shadow-md" style="background-color: var(--primary);">
        <div class="container mx-auto px-4">
            <h1 class="text-white text-3xl font-bold text-center">Asistente de Antigüedades Santa Emilia</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- Setup Screen -->
        <div id="setup-screen" class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">Configuración Inicial</h2>
            <p class="mb-4">Para utilizar todas las funcionalidades del asistente, necesitas configurar las siguientes API keys:</p>
            
            <div class="mb-4">
                <div class="flex items-center mb-1">
                    <div id="openai-status" class="w-3 h-3 bg-red-600 rounded-full mr-2"></div>
                    <label for="openai-api-key" class="font-medium">API Key de OpenAI:</label>
                </div>
                <input type="password" id="openai-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" placeholder="sk-...">
            </div>

            <div class="mb-6">
                <div class="flex items-center mb-1">
                    <div id="perplexity-status" class="w-3 h-3 bg-red-600 rounded-full mr-2"></div>
                    <label for="perplexity-api-key" class="font-medium">API Key de Perplexity:</label>
                </div>
                <input type="password" id="perplexity-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" placeholder="pplx-...">
            </div>

            <p class="text-sm text-blue-600 bg-blue-50 p-3 rounded-md mb-4">
                <i class="fas fa-info-circle mr-1"></i> Las API keys se almacenan localmente en tu navegador y nunca se envían a ningún servidor externo.
            </p>

            <button id="save-api-keys" class="w-full py-2 px-4 bg-accent text-white font-medium rounded-md hover:bg-accent-hover" style="background-color: var(--accent);">
                Guardar Configuración
            </button>
        </div>

        <!-- Main Content Area (hidden initially if API keys not set) -->
        <div id="main-content" class="hidden">
            <!-- Navigation Tabs -->
            <div class="flex border-b border-gray-300 mb-6">
                <button class="tab active px-4 py-2 font-medium border-b-2 border-transparent" data-target="analyze-tab">
                    Analizar Antigüedad
                </button>
                <button class="tab px-4 py-2 font-medium border-b-2 border-transparent" data-target="portfolio-tab">
                    Portfolio
                </button>
                <button class="tab px-4 py-2 font-medium border-b-2 border-transparent" data-target="settings-tab">
                    Configuración
                </button>
            </div>

            <!-- Analyze Tab -->
            <div id="analyze-tab" class="tab-content">
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-4">Analizar Nueva Antigüedad</h2>
                    
                    <div id="dropzone" class="dropzone p-8 rounded-lg text-center cursor-pointer mb-6">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p>Arrastra y suelta imágenes aquí o haz clic para seleccionar archivos</p>
                        <p class="text-sm text-gray-500 mt-1">Formatos aceptados: JPG, PNG, JPEG, WEBP</p>
                        <input type="file" id="file-input" class="hidden" accept="image/jpeg,image/png,image/jpg,image/webp" multiple>
                    </div>

                    <div id="image-preview-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6"></div>

                    <button id="analyze-btn" class="py-2 px-4 bg-accent text-white font-medium rounded-md hover:bg-accent-hover btn disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--accent);" disabled>
                        Comenzar Análisis
                    </button>
                </div>

                <!-- Analysis Progress (hidden initially) -->
                <div id="analysis-progress" class="bg-white p-6 rounded-lg shadow-lg mb-8 hidden">
                    <h2 class="text-2xl font-bold mb-4">Progreso del Análisis</h2>
                    
                    <div class="mb-4">
                        <div class="progress-bar mb-2">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <p id="progress-text" class="text-sm text-gray-600">Preparando análisis...</p>
                    </div>

                    <div class="flex items-center">
                        <div class="spinner mr-3"></div>
                        <p id="current-step">Inicializando...</p>
                    </div>
                </div>

                <!-- Analysis Results (hidden initially) -->
                <div id="analysis-results" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Resultados del Análisis</h2>

                    <div class="flex border-b border-gray-300 mb-6">
                        <button class="tab active px-4 py-2 font-medium border-b-2 border-transparent" data-target="research-content">
                            Investigación
                        </button>
                        <button class="tab px-4 py-2 font-medium border-b-2 border-transparent" data-target="woo-content">
                            WooCommerce
                        </button>
                        <button class="tab px-4 py-2 font-medium border-b-2 border-transparent" data-target="insta-content">
                            Instagram
                        </button>
                        <button class="tab px-4 py-2 font-medium border-b-2 border-transparent" data-target="json-content">
                            Datos JSON
                        </button>
                    </div>

                    <div id="research-content" class="tab-content bg-white p-6 rounded-lg shadow-lg mb-8">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-3">Imagen Seleccionada</h3>
                            <div id="best-image-container" class="max-w-md mx-auto mb-4"></div>
                            <p id="best-image-explanation" class="text-gray-600 italic text-center"></p>
                        </div>
                        <div id="research-sections"></div>
                    </div>

                    <div id="woo-content" class="tab-content bg-white p-6 rounded-lg shadow-lg mb-8 hidden">
                        <div id="woo-sections"></div>
                    </div>

                    <div id="insta-content" class="tab-content bg-white p-6 rounded-lg shadow-lg mb-8 hidden">
                        <div id="insta-sections"></div>
                    </div>

                    <div id="json-content" class="tab-content bg-white p-6 rounded-lg shadow-lg mb-8 hidden">
                        <h3 class="text-xl font-bold mb-3">Datos en formato JSON</h3>
                        <p class="mb-3">Estos son los datos completos del análisis en formato JSON:</p>
                        <pre id="json-data" class="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm"></pre>
                    </div>

                    <div class="text-center">
                        <button id="save-to-portfolio" class="py-2 px-6 bg-accent text-white font-medium rounded-md hover:bg-accent-hover btn" style="background-color: var(--accent);">
                            Guardar en Portfolio
                        </button>
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div id="portfolio-tab" class="tab-content hidden">
                <div id="empty-portfolio" class="bg-white p-6 rounded-lg shadow-lg text-center hidden">
                    <h2 class="text-2xl font-bold mb-4">Portfolio Vacío</h2>
                    <p class="mb-4">Aún no has analizado ninguna antigüedad. Utiliza la opción "Analizar Antigüedad" para comenzar a construir tu portfolio.</p>
                </div>

                <div id="portfolio-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-xl font-bold mb-2">Total de Piezas</h3>
                            <p id="total-pieces" class="text-3xl font-bold" style="color: var(--accent);">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-xl font-bold mb-2">Valor Estimado</h3>
                            <p id="total-value" class="text-3xl font-bold" style="color: var(--accent);">€0</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                            <h3 class="text-xl font-bold mb-2">Pieza Más Valiosa</h3>
                            <p id="most-valuable" class="text-3xl font-bold" style="color: var(--accent);">€0</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Tu Colección</h2>
                            <div>
                                <button id="export-data" class="py-2 px-4 bg-blue-600 text-white font-medium rounded-md mr-2 btn">
                                    Exportar Datos
                                </button>
                                <button id="import-data" class="py-2 px-4 bg-gray-600 text-white font-medium rounded-md btn">
                                    Importar Datos
                                </button>
                                <input type="file" id="import-file" class="hidden" accept=".json">
                            </div>
                        </div>
                        <div id="portfolio-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-4">API Keys</h2>
                    
                    <div class="mb-4">
                        <div class="flex items-center mb-1">
                            <div id="settings-openai-status" class="w-3 h-3 rounded-full mr-2"></div>
                            <label for="settings-openai-api-key" class="font-medium">API Key de OpenAI:</label>
                        </div>
                        <input type="password" id="settings-openai-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" placeholder="sk-...">
                    </div>

                    <div class="mb-6">
                        <div class="flex items-center mb-1">
                            <div id="settings-perplexity-status" class="w-3 h-3 rounded-full mr-2"></div>
                            <label for="settings-perplexity-api-key" class="font-medium">API Key de Perplexity:</label>
                        </div>
                        <input type="password" id="settings-perplexity-api-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent" placeholder="pplx-...">
                    </div>

                    <button id="update-api-keys" class="py-2 px-4 bg-accent text-white font-medium rounded-md hover:bg-accent-hover btn" style="background-color: var(--accent);">
                        Actualizar API Keys
                    </button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Gestión de Datos</h2>
                    <p class="mb-4">Las siguientes acciones afectarán a los datos almacenados localmente:</p>
                    
                    <button id="clear-portfolio" class="py-2 px-4 bg-yellow-600 text-white font-medium rounded-md mr-2 btn">
                        Limpiar Portfolio
                    </button>
                    <button id="reset-all" class="py-2 px-4 bg-red-600 text-white font-medium rounded-md btn">
                        Restablecer Todo
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-primary-dark py-6 text-white text-center mt-12" style="background-color: var(--primary-dark);">
        <div class="container mx-auto px-4">
            <p>&copy; 2025 Santa Emilia Antigüedades. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Global variables
            let uploadedImages = [];
            let selectedImageIndex = null;
            let antiques = JSON.parse(localStorage.getItem('antiques') || '[]');
            let currentAnalysisResult = null;
            let analysisInProgress = false;

            // DOM elements
            const setupScreen = document.getElementById('setup-screen');
            const mainContent = document.getElementById('main-content');
            const openaiApiKeyInput = document.getElementById('openai-api-key');
            const perplexityApiKeyInput = document.getElementById('perplexity-api-key');
            const openaiStatus = document.getElementById('openai-status');
            const perplexityStatus = document.getElementById('perplexity-status');
            const saveApiKeysBtn = document.getElementById('save-api-keys');
            const settingsOpenaiApiKeyInput = document.getElementById('settings-openai-api-key');
            const settingsPerplexityApiKeyInput = document.getElementById('settings-perplexity-api-key');
            const settingsOpenaiStatus = document.getElementById('settings-openai-status');
            const settingsPerplexityStatus = document.getElementById('settings-perplexity-status');
            const updateApiKeysBtn = document.getElementById('update-api-keys');
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const analyzeBtn = document.getElementById('analyze-btn');
            const progressBar = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const currentStep = document.getElementById('current-step');
            const analysisProgress = document.getElementById('analysis-progress');
            const analysisResults = document.getElementById('analysis-results');
            const bestImageContainer = document.getElementById('best-image-container');
            const bestImageExplanation = document.getElementById('best-image-explanation');
            const researchSections = document.getElementById('research-sections');
            const wooSections = document.getElementById('woo-sections');
            const instaSections = document.getElementById('insta-sections');
            const jsonData = document.getElementById('json-data');
            const saveToPortfolioBtn = document.getElementById('save-to-portfolio');
            const portfolioItems = document.getElementById('portfolio-items');
            const totalPieces = document.getElementById('total-pieces');
            const totalValue = document.getElementById('total-value');
            const mostValuable = document.getElementById('most-valuable');
            const emptyPortfolio = document.getElementById('empty-portfolio');
            const portfolioContent = document.getElementById('portfolio-content');
            const exportDataBtn = document.getElementById('export-data');
            const importDataBtn = document.getElementById('import-data');
            const importFile = document.getElementById('import-file');
            const clearPortfolioBtn = document.getElementById('clear-portfolio');
            const resetAllBtn = document.getElementById('reset-all');

            // Initialize app
            init();

            // App initialization
            function init() {
                loadApiKeys();
                setupEventListeners();
                updatePortfolioView();
            }

            // Load API keys from local storage
            function loadApiKeys() {
                const openaiApiKey = localStorage.getItem('openai_api_key');
                const perplexityApiKey = localStorage.getItem('perplexity_api_key');
                
                if (openaiApiKey && perplexityApiKey) {
                    openaiApiKeyInput.value = openaiApiKey;
                    perplexityApiKeyInput.value = perplexityApiKey;
                    settingsOpenaiApiKeyInput.value = openaiApiKey;
                    settingsPerplexityApiKeyInput.value = perplexityApiKey;
                    openaiStatus.classList.remove('bg-red-600');
                    openaiStatus.classList.add('bg-green-600');
                    perplexityStatus.classList.remove('bg-red-600');
                    perplexityStatus.classList.add('bg-green-600');
                    settingsOpenaiStatus.classList.remove('bg-red-600');
                    settingsOpenaiStatus.classList.add('bg-green-600');
                    settingsPerplexityStatus.classList.remove('bg-red-600');
                    settingsPerplexityStatus.classList.add('bg-green-600');
                    setupScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else {
                    setupScreen.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                }
            }

            // Setup event listeners
            function setupEventListeners() {
                // API Keys
                saveApiKeysBtn.addEventListener('click', saveApiKeys);
                updateApiKeysBtn.addEventListener('click', saveApiKeys);

                // Navigation tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const parent = tab.parentElement;
                        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const targetId = tab.dataset.target;
                        if (targetId) {
                            document.querySelectorAll('.tab-content').forEach(content => {
                                content.classList.add('hidden');
                            });
                            document.getElementById(targetId).classList.remove('hidden');
                            
                            // If switching to portfolio tab, update the view
                            if (targetId === 'portfolio-tab') {
                                updatePortfolioView();
                            }
                        }
                    });
                });

                // File upload
                dropzone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileSelection);
                
                // Drag and drop
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('dragover');
                });
                
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        handleFiles(e.dataTransfer.files);
                    }
                });

                // Analysis
                analyzeBtn.addEventListener('click', startAnalysis);
                saveToPortfolioBtn.addEventListener('click', saveToPortfolio);

                // Portfolio management
                exportDataBtn.addEventListener('click', exportData);
                importDataBtn.addEventListener('click', () => importFile.click());
                importFile.addEventListener('change', importData);
                clearPortfolioBtn.addEventListener('click', clearPortfolio);
                resetAllBtn.addEventListener('click', resetAll);
            }

            // Save API keys
            function saveApiKeys() {
                const openaiKey = this.id === 'update-api-keys' ? settingsOpenaiApiKeyInput.value : openaiApiKeyInput.value;
                const perplexityKey = this.id === 'update-api-keys' ? settingsPerplexityApiKeyInput.value : perplexityApiKeyInput.value;
                
                if (openaiKey && perplexityKey) {
                    localStorage.setItem('openai_api_key', openaiKey);
                    localStorage.setItem('perplexity_api_key', perplexityKey);
                    
                    // Update all input fields
                    openaiApiKeyInput.value = openaiKey;
                    perplexityApiKeyInput.value = perplexityKey;
                    settingsOpenaiApiKeyInput.value = openaiKey;
                    settingsPerplexityApiKeyInput.value = perplexityKey;
                    
                    // Update status indicators
                    [openaiStatus, settingsOpenaiStatus].forEach(el => {
                        el.classList.remove('bg-red-600');
                        el.classList.add('bg-green-600');
                    });
                    
                    [perplexityStatus, settingsPerplexityStatus].forEach(el => {
                        el.classList.remove('bg-red-600');
                        el.classList.add('bg-green-600');
                    });
                    
                    // Show main content if on setup screen
                    if (!mainContent.classList.contains('hidden')) return;
                    
                    setupScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                } else {
                    alert('Debes ingresar ambas API keys para continuar.');
                }
            }

            // Handle file selection
            function handleFileSelection(e) {
                if (e.target.files.length > 0) {
                    handleFiles(e.target.files);
                }
            }

            // Handle files (from input or drop)
            function handleFiles(files) {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            uploadedImages.push({
                                file: file,
                                dataUrl: e.target.result
                            });
                            updateImagePreviews();
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            // Update image previews
            function updateImagePreviews() {
                imagePreviewContainer.innerHTML = '';
                
                if (uploadedImages.length > 0) {
                    analyzeBtn.removeAttribute('disabled');
                } else {
                    analyzeBtn.setAttribute('disabled', 'disabled');
                    return;
                }
                
                uploadedImages.forEach((image, index) => {
                    const previewEl = document.createElement('div');
                    previewEl.className = 'image-preview rounded-lg overflow-hidden shadow-md';
                    
                    const imgEl = document.createElement('img');
                    imgEl.src = image.dataUrl;
                    imgEl.className = 'w-full';
                    imgEl.alt = 'Preview';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        uploadedImages.splice(index, 1);
                        updateImagePreviews();
                    });
                    
                    previewEl.appendChild(imgEl);
                    previewEl.appendChild(removeBtn);
                    imagePreviewContainer.appendChild(previewEl);
                });
            }

            // Start analysis process
            function startAnalysis() {
                if (analysisInProgress || uploadedImages.length === 0) return;
                
                analysisInProgress = true;
                currentAnalysisResult = null;
                selectedImageIndex = null;
                
                // Show progress UI
                analyzeBtn.setAttribute('disabled', 'disabled');
                analysisProgress.classList.remove('hidden');
                analysisResults.classList.add('hidden');
                
                // Reset progress
                updateProgress(0, 'Preparando análisis...');
                
                // Analysis flow
                analyzeImages()
                    .then(selectBestImage)
                    .then(performDeepResearch)
                    .then(generateContent)
                    .then(showResults)
                    .catch(error => {
                        console.error('Error en el análisis:', error);
                        alert('Error en el análisis: ' + error.message);
                        analysisInProgress = false;
                        analyzeBtn.removeAttribute('disabled');
                        analysisProgress.classList.add('hidden');
                    });
            }

            // Step 1: Analyze images with OpenAI
            async function analyzeImages() {
                updateProgress(10, 'Analizando imágenes...');
                currentStep.textContent = 'Analizando imágenes con OpenAI...';
                
                const openaiApiKey = localStorage.getItem('openai_api_key');
                if (!openaiApiKey) throw new Error('API Key de OpenAI no configurada');
                
                // If only one image, select it automatically
                if (uploadedImages.length === 1) {
                    selectedImageIndex = 0;
                    return {
                        selectedIndex: 0,
                        explanation: 'Única imagen disponible para análisis.',
                        initialAnalysis: await analyzeImage(uploadedImages[0].dataUrl, openaiApiKey)
                    };
                }
                
                // Prepare content for each image
                const imageContents = uploadedImages.map((img, index) => [
                    {
                        "type": "text",
                        "text": `Imagen ${index + 1}:`
                    },
                    {
                        "type": "image_url",
                        "image_url": {
                            "url": img.dataUrl
                        }
                    }
                ]).flat();
                
                // Call OpenAI to select the best image
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres un experto en fotografía y marketing de antigüedades. Tu tarea es analizar varias fotografías de una misma pieza para determinar cuál es la mejor para publicidad y ventas online. Considera claridad, ángulo, iluminación, detalle, y representatividad de la pieza.'
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Analiza estas imágenes de una antigüedad y selecciona la mejor para usar en marketing y ventas online:'
                                    },
                                    ...imageContents,
                                    {
                                        type: 'text',
                                        text: 'Indica el número de la imagen seleccionada y explica detalladamente por qué es la mejor opción para marketing. Tu respuesta debe tener este formato: "Imagen seleccionada: X\n\nExplicación: [explicación detallada]". Al final, describe brevemente la pieza que ves en las imágenes.'
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error de OpenAI: ${error.error?.message || 'Error desconocido'}`);
                }
                
                const result = await response.json();
                const content = result.choices[0].message.content;
                
                // Extract selected image index
                const match = content.match(/Imagen seleccionada:\s*(\d+)/i);
                const selectedIndex = match ? parseInt(match[1]) - 1 : 0;
                
                // Extract explanation
                const explanationMatch = content.match(/Explicación:\s*([\s\S]+?)(?=\n\n|$)/i);
                const explanation = explanationMatch ? explanationMatch[1].trim() : '';
                
                // Analyze the selected image in detail
                const initialAnalysis = await analyzeImage(uploadedImages[selectedIndex].dataUrl, openaiApiKey);
                
                return {
                    selectedIndex,
                    explanation,
                    initialAnalysis
                };
            }
            
            // Analyze a single image with OpenAI
            async function analyzeImage(imageDataUrl, apiKey) {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres un experto tasador y catalogador de antigüedades con amplios conocimientos de historia del arte, estilos decorativos y mobiliario histórico. Observa cuidadosamente los detalles y proporciona un análisis completo.'
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Describe detalladamente esta pieza antigua. Identifica qué es, de qué época parece ser, materiales, técnicas utilizadas, estilo artístico y cualquier detalle distintivo que observes.'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: imageDataUrl
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error de OpenAI: ${error.error?.message || 'Error desconocido'}`);
                }
                
                const result = await response.json();
                return result.choices[0].message.content;
            }

            // Step 2: Select the best image
            function selectBestImage(analysisResult) {
                updateProgress(30, 'Seleccionando la mejor imagen para marketing...');
                currentStep.textContent = 'Procesando selección de imagen...';
                
                selectedImageIndex = analysisResult.selectedIndex;
                
                return {
                    ...analysisResult,
                    selectedImageUrl: uploadedImages[selectedImageIndex].dataUrl,
                    selectedImageFile: uploadedImages[selectedImageIndex].file
                };
            }

            // Step 3: Perform deep research with Perplexity
            async function performDeepResearch(analysisResult) {
                updateProgress(50, 'Realizando investigación profunda...');
                currentStep.textContent = 'Investigando con Perplexity...';
                
                const perplexityApiKey = localStorage.getItem('perplexity_api_key');
                if (!perplexityApiKey) throw new Error('API Key de Perplexity no configurada');
                
                // Call Perplexity API for deep research
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${perplexityApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3-sonar-small-online',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres un historiador y experto en antigüedades con amplio conocimiento. Realiza una investigación profunda sobre la pieza descrita y proporciona información detallada sobre su origen, estilo, propósito, materiales y particularidades. Incluye referencias a fuentes académicas o catálogos relevantes cuando sea posible. Busca información precisa y académica.'
                            },
                            {
                                role: 'user',
                                content: `Basándote en esta descripción, realiza una investigación completa y académica de esta pieza antigua: ${analysisResult.initialAnalysis}
                                
                                Proporciona la siguiente información con el máximo detalle posible:
                                1. ORIGEN: Lugar, taller o fabricante probable, contexto histórico-cultural
                                2. PERIODO: Época exacta o aproximada de fabricación con justificación
                                3. ESTILO: Clasificación estilística, características distintivas, contexto artístico
                                4. MATERIALES Y TÉCNICAS: Análisis detallado de materiales, métodos de fabricación
                                5. VALOR DE MERCADO: Rango de precios actual con ejemplos de piezas similares en subastas o ventas recientes
                                6. PARTICULARIDADES: Elementos distintivos, rareza, estado de conservación
                                
                                Cada sección debe incluir al menos una fuente citada específica (nombre de casa de subastas, título de libro, nombre de museo, catálogo específico, etc.). Las fuentes deben ser reales, verificables y relevantes para el tipo de pieza.`
                            }
                        ],
                        max_tokens: 4000
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`Error de Perplexity: ${error.error || 'Error desconocido'}`);
                }
                
                const result = await response.json();
                const researchContent = result.choices[0].message.content;
                
                // Parse the research content into structured data
                const researchData = parseResearchContent(researchContent);
                
                return {
                    ...analysisResult,
                    research: researchContent,
                    researchData
                };
            }
            
            // Parse research content into structured data
            function parseResearchContent(content) {
                const sections = {
                    origen: '',
                    periodo: '',
                    estilo: '',
                    materiales_tecnicas: '',
                    valor_mercado: '',
                    particularidades: '',
                    fuentes: []
                };
                
                // Extract sections
                const origenMatch = content.match(/ORIGEN:[\s\S]+?(?=\n\s*\d+\.|$)/i);
                const periodoMatch = content.match(/PERIODO:[\s\S]+?(?=\n\s*\d+\.|$)/i);
                const estiloMatch = content.match(/ESTILO:[\s\S]+?(?=\n\s*\d+\.|$)/i);
                const materialesMatch = content.match(/MATERIALES Y TÉCNICAS:[\s\S]+?(?=\n\s*\d+\.|$)/i);
                const valorMatch = content.match(/VALOR DE MERCADO:[\s\S]+?(?=\n\s*\d+\.|$)/i);
                const particularidadesMatch = content.match(/PARTICULARIDADES:[\s\S]+?(?=\n\s*\d+\.|$)/i);
                
                // Extract value range for portfolio statistics
                let valueRange = {min: 0, max: 0};
                if (valorMatch) {
                    const valueText = valorMatch[0];
                    const amounts = valueText.match(/\d{1,3}(?:[,.]\d{3})*(?:[,.]\d{1,2})?/g);
                    if (amounts && amounts.length >= 2) {
                        // Convert found amounts to numbers
                        const numericAmounts = amounts.map(a => 
                            parseFloat(a.replace(/[,.]/g, match => match === ',' ? (a.includes('.') ? ',' : '') : '.'))
                        ).filter(n => !isNaN(n) && n > 0);
                        
                        if (numericAmounts.length >= 2) {
                            valueRange.min = Math.min(...numericAmounts);
                            valueRange.max = Math.max(...numericAmounts);
                        } else if (numericAmounts.length === 1) {
                            valueRange.min = valueRange.max = numericAmounts[0];
                        }
                    }
                }
                
                // Extract sources
                const sourcesPattern = /(?:\d+\.\s+|\*\s+)([\w\s]+(?:[,.]\s*[\w\s]+)*),\s+"[^"]+",\s*([\w\s]+),\s*\d{4}/gi;
                const sourcesMatches = content.matchAll(sourcesPattern);
                for (const match of sourcesMatches) {
                    if (match[0]) sections.fuentes.push(match[0].trim());
                }
                
                // If no sources found with the pattern, try to find a "FUENTES:" section
                if (sections.fuentes.length === 0) {
                    const fuentesMatch = content.match(/FUENTES:[\s\S]+/i);
                    if (fuentesMatch) {
                        const fuentesText = fuentesMatch[0].replace(/FUENTES:/i, '').trim();
                        const fuentesList = fuentesText.split(/\n+/).map(s => s.trim()).filter(s => s);
                        sections.fuentes = fuentesList;
                    }
                }
                
                // If still no sources, extract lines that look like citations
                if (sections.fuentes.length === 0) {
                    const potentialSources = content.match(/(?:\d+\.\s+|\*\s+|—\s+)([\w\s]+(?:[,.]\s*[\w\s]+)*),\s+(?:"[^"]+"|\d{4}|[^,]+)/g);
                    if (potentialSources) {
                        sections.fuentes = potentialSources.map(s => s.trim());
                    }
                }
                
                // Assign content to sections
                if (origenMatch) sections.origen = origenMatch[0].replace(/ORIGEN:/i, '').trim();
                if (periodoMatch) sections.periodo = periodoMatch[0].replace(/PERIODO:/i, '').trim();
                if (estiloMatch) sections.estilo = estiloMatch[0].replace(/ESTILO:/i, '').trim();
                if (materialesMatch) sections.materiales_tecnicas = materialesMatch[0].replace(/MATERIALES Y TÉCNICAS:/i, '').trim();
                if (valorMatch) sections.valor_mercado = valorMatch[0].replace(/VALOR DE MERCADO:/i, '').trim();
                if (particularidadesMatch) sections.particularidades = particularidadesMatch[0].replace(/PARTICULARIDADES:/i, '').trim();
                
                return {
                    ...sections,
                    valueRange
                };
            }

            // Step 4: Generate content for WooCommerce and Instagram
            async function generateContent(analysisResult) {
                updateProgress(80, 'Generando contenido...');
                currentStep.textContent = 'Creando contenido para WooCommerce e Instagram...';
                
                const openaiApiKey = localStorage.getItem('openai_api_key');
                if (!openaiApiKey) throw new Error('API Key de OpenAI no configurada');
                
                // Generate WooCommerce content
                const wooResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres un especialista en marketing de antigüedades y e-commerce. Tu tarea es crear descripciones completas y atractivas para productos de alta gama en una tienda WooCommerce, manteniendo rigor histórico y técnico pero con un enfoque comercial. La descripción debe ser sofisticada y atractiva para coleccionistas y amantes de las antigüedades.'
                            },
                            {
                                role: 'user',
                                content: `Crea una descripción completa para WooCommerce de esta antigüedad basada en la siguiente investigación:
                                
                                ${analysisResult.research}
                                
                                Necesito estos elementos:
                                1. TÍTULO DEL PRODUCTO: Nombre comercial atractivo pero técnicamente preciso (máx. 70 caracteres)
                                2. DESCRIPCIÓN CORTA: Resumen conciso y elegante (2-3 frases)
                                3. DESCRIPCIÓN COMPLETA: Descripción detallada en HTML con formato profesional
                                   - Debe incluir todos los detalles técnicos (origen, periodo, estilo, materiales)
                                   - Debe mencionar el valor e importancia de la pieza
                                   - Debe tener párrafos bien estructurados con subtítulos en <h3>
                                   - Debe incluir al final una sección de procedencia/autenticación
                                4. META DESCRIPCIÓN: Texto SEO optimizado (máx. 160 caracteres)
                                5. CATEGORÍAS: Sugerencia de categorías para la tienda (3-5)
                                6. ETIQUETAS: Keywords relevantes para búsquedas (8-10)
                                
                                Estructura tu respuesta en formato JSON con las claves: titulo, descripcion_corta, descripcion_completa, meta_descripcion, categorias, etiquetas.`
                            }
                        ],
                        response_format: { "type": "json_object" },
                        max_tokens: 2000
                    })
                });
                
                if (!wooResponse.ok) {
                    const error = await wooResponse.json();
                    throw new Error(`Error de OpenAI (WooCommerce): ${error.error?.message || 'Error desconocido'}`);
                }
                
                const wooResult = await wooResponse.json();
                const wooContent = JSON.parse(wooResult.choices[0].message.content);
                
                // Generate Instagram content
                const instaResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: 'Eres un especialista en marketing digital para antigüedades y arte de lujo. Tu objetivo es crear posts cautivadores para Instagram que comuniquen elegancia, exclusividad y conocimiento. El tono debe ser sofisticado y atractivo para un público de alto poder adquisitivo.'
                            },
                            {
                                role: 'user',
                                content: `Crea un post para Instagram sobre esta antigüedad basado en la siguiente investigación:
                                
                                ${analysisResult.research}
                                
                                El post debe incluir:
                                1. TEXTO PRINCIPAL: Texto cautivador y elegante (máximo 100 palabras)
                                   - Debe destacar lo más interesante y valioso de la pieza
                                   - Debe mencionar que está disponible en Santa Emilia
                                   - Debe tener un tono exclusivo y sofisticado
                                2. HASHTAGS: 8-12 hashtags relevantes y efectivos
                                3. CALL TO ACTION: Invitación elegante a visitar o contactar
                                
                                Estructura tu respuesta en formato JSON con las claves: texto_principal, hashtags, call_to_action.`
                            }
                        ],
                        response_format: { "type": "json_object" },
                        max_tokens: 1000
                    })
                });
                
                if (!instaResponse.ok) {
                    const error = await instaResponse.json();
                    throw new Error(`Error de OpenAI (Instagram): ${error.error?.message || 'Error desconocido'}`);
                }
                
                const instaResult = await instaResponse.json();
                const instaContent = JSON.parse(instaResult.choices[0].message.content);
                
                // Complete result
                currentAnalysisResult = {
                    ...analysisResult,
                    wooContent,
                    instaContent,
                    timestamp: new Date().toISOString()
                };
                
                return currentAnalysisResult;
            }

            // Step 5: Show results
            function showResults(result) {
                updateProgress(100, 'Análisis completado');
                currentStep.textContent = 'Análisis completado satisfactoriamente';
                
                setTimeout(() => {
                    analysisProgress.classList.add('hidden');
                    analysisResults.classList.remove('hidden');
                    analyzeBtn.removeAttribute('disabled');
                    analysisInProgress = false;
                    
                    // Show the best image
                    bestImageContainer.innerHTML = '';
                    const bestImageEl = document.createElement('img');
                    bestImageEl.src = result.selectedImageUrl;
                    bestImageEl.className = 'w-full rounded-lg shadow-md';
                    bestImageEl.alt = 'Mejor imagen para marketing';
                    bestImageContainer.appendChild(bestImageEl);
                    
                    // Show explanation
                    bestImageExplanation.textContent = result.explanation;
                    
                    // Show research results
                    researchSections.innerHTML = '';
                    
                    // Add research sections
                    const sections = [
                        { key: 'origen', title: 'Origen' },
                        { key: 'periodo', title: 'Periodo' },
                        { key: 'estilo', title: 'Estilo' },
                        { key: 'materiales_tecnicas', title: 'Materiales y Técnicas' },
                        { key: 'valor_mercado', title: 'Valor de Mercado' },
                        { key: 'particularidades', title: 'Particularidades' }
                    ];
                    
                    sections.forEach(section => {
                        if (result.researchData[section.key]) {
                            const sectionEl = document.createElement('div');
                            sectionEl.className = 'mb-6';
                            sectionEl.innerHTML = `
                                <h3 class="text-xl font-bold mb-2">${section.title}</h3>
                                <p>${result.researchData[section.key].replace(/\n/g, '<br>')}</p>
                            `;
                            researchSections.appendChild(sectionEl);
                        }
                    });
                    
                    // Add sources
                    if (result.researchData.fuentes && result.researchData.fuentes.length > 0) {
                        const sourcesEl = document.createElement('div');
                        sourcesEl.className = 'mb-6';
                        sourcesEl.innerHTML = `
                            <h3 class="text-xl font-bold mb-2">Fuentes</h3>
                            <ul class="list-disc pl-5">
                                ${result.researchData.fuentes.map(source => `<li>${source}</li>`).join('')}
                            </ul>
                        `;
                        researchSections.appendChild(sourcesEl);
                    }
                    
                    // WooCommerce content
                    wooSections.innerHTML = '';
                    const wooContentEl = document.createElement('div');
                    wooContentEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Título del Producto</h3>
                            <p class="p-3 bg-gray-100 rounded-lg">${result.wooContent.titulo}</p>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Descripción Corta</h3>
                            <p class="p-3 bg-gray-100 rounded-lg">${result.wooContent.descripcion_corta}</p>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Descripción Completa</h3>
                            <div class="p-3 bg-gray-100 rounded-lg">
                                ${result.wooContent.descripcion_completa}
                            </div>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Meta Descripción</h3>
                            <p class="p-3 bg-gray-100 rounded-lg">${result.wooContent.meta_descripcion}</p>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Categorías</h3>
                            <div class="p-3 bg-gray-100 rounded-lg">
                                ${Array.isArray(result.wooContent.categorias) 
                                    ? result.wooContent.categorias.map(cat => `<span class="inline-block bg-primary text-white px-2 py-1 rounded-full text-sm mr-2 mb-2">${cat}</span>`).join('') 
                                    : result.wooContent.categorias.split(',').map(cat => `<span class="inline-block bg-primary text-white px-2 py-1 rounded-full text-sm mr-2 mb-2">${cat.trim()}</span>`).join('')}
                            </div>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Etiquetas</h3>
                            <div class="p-3 bg-gray-100 rounded-lg">
                                ${Array.isArray(result.wooContent.etiquetas) 
                                    ? result.wooContent.etiquetas.map(tag => `<span class="inline-block bg-gray-200 px-2 py-1 rounded-full text-sm mr-2 mb-2">${tag}</span>`).join('') 
                                    : result.wooContent.etiquetas.split(',').map(tag => `<span class="inline-block bg-gray-200 px-2 py-1 rounded-full text-sm mr-2 mb-2">${tag.trim()}</span>`).join('')}
                            </div>
                        </div>
                    `;
                    wooSections.appendChild(wooContentEl);
                    
                    // Instagram content
                    instaSections.innerHTML = '';
                    const instaContentEl = document.createElement('div');
                    instaContentEl.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Imagen para Instagram</h3>
                            <img src="${result.selectedImageUrl}" alt="Imagen para Instagram" class="w-full max-w-md mx-auto rounded-lg shadow-md">
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Texto Principal</h3>
                            <p class="p-3 bg-gray-100 rounded-lg">${result.instaContent.texto_principal}</p>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Hashtags</h3>
                            <p class="p-3 bg-gray-100 rounded-lg">
                                ${Array.isArray(result.instaContent.hashtags) 
                                    ? result.instaContent.hashtags.map(tag => `<span class="text-blue-500">${tag} </span>`).join(' ') 
                                    : result.instaContent.hashtags.split(' ').map(tag => `<span class="text-blue-500">${tag} </span>`).join(' ')}
                            </p>
                        </div>
                        <div class="mb-4">
                            <h3 class="text-xl font-bold mb-2">Call to Action</h3>
                            <p class="p-3 bg-gray-100 rounded-lg">${result.instaContent.call_to_action}</p>
                        </div>
                    `;
                    instaSections.appendChild(instaContentEl);
                    
                    // JSON data
                    jsonData.textContent = JSON.stringify(result, null, 2);
                }, 1000);
            }

            // Update progress bar
            function updateProgress(percent, text) {
                progressBar.style.width = `${percent}%`;
                progressText.textContent = text;
            }

            // Save current analysis to portfolio
            function saveToPortfolio() {
                if (!currentAnalysisResult) return;
                
                // Create a unique ID for this item
                const id = 'antique_' + Date.now();
                
                // Prepare image data
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Create portfolio item
                    const portfolioItem = {
                        id,
                        title: currentAnalysisResult.wooContent.titulo,
                        description: currentAnalysisResult.wooContent.descripcion_corta,
                        image: e.target.result,
                        timestamp: currentAnalysisResult.timestamp,
                        style: extractMainStyle(currentAnalysisResult.researchData.estilo),
                        period: extractMainPeriod(currentAnalysisResult.researchData.periodo),
                        valueRange: currentAnalysisResult.researchData.valueRange,
                        fullData: currentAnalysisResult
                    };
                    
                    // Add to antiques array
                    antiques.push(portfolioItem);
                    localStorage.setItem('antiques', JSON.stringify(antiques));
                    
                    // Show success message
                    alert('Antigüedad guardada exitosamente en el portfolio.');
                    
                    // Update portfolio view if visible
                    if (!document.getElementById('portfolio-tab').classList.contains('hidden')) {
                        updatePortfolioView();
                    }
                };
                reader.readAsDataURL(currentAnalysisResult.selectedImageFile);
            }

            // Extract main style from style description
            function extractMainStyle(styleText) {
                if (!styleText) return 'No especificado';
                
                // Common styles to look for
                const commonStyles = [
                    'Barroco', 'Rococó', 'Neoclásico', 'Art Nouveau', 'Art Deco',
                    'Renacimiento', 'Gótico', 'Victoriano', 'Isabelino', 'Luis XV',
                    'Luis XVI', 'Imperio', 'Regencia', 'Georgiano', 'Chippendale',
                    'Hepplewhite', 'Sheraton', 'Biedermeier', 'Modernista', 'Medieval'
                ];
                
                // Look for these styles in the text
                for (const style of commonStyles) {
                    if (styleText.includes(style)) return style;
                }
                
                // If no known style found, try to extract the first sentence
                const firstSentence = styleText.split('.')[0];
                if (firstSentence.length < 50) return firstSentence;
                
                return 'Estilo mixto';
            }

            // Extract main period from period description
            function extractMainPeriod(periodText) {
                if (!periodText) return 'No especificado';
                
                // Look for century patterns like "siglo XIX" or "siglo 19"
                const centuryMatch = periodText.match(/siglo\s+(\w+)/i);
                if (centuryMatch) return `Siglo ${centuryMatch[1]}`;
                
                // Look for year ranges like "1880-1920"
                const yearRangeMatch = periodText.match(/(\d{4})\s*[-–]\s*(\d{4})/);
                if (yearRangeMatch) return `${yearRangeMatch[1]}-${yearRangeMatch[2]}`;
                
                // Look for circa years like "c. 1850"
                const circaMatch = periodText.match(/(?:c|circa|ca)\.\s*(\d{4})/i);
                if (circaMatch) return `ca. ${circaMatch[1]}`;
                
                // Look for decades like "década de 1920"
                const decadeMatch = periodText.match(/década\s+(?:de\s+)?(\d{4})/i);
                if (decadeMatch) return `Década ${decadeMatch[1]}`;
                
                // If no pattern found, return first 30 characters
                return periodText.substring(0, 30) + '...';
            }

            // Update portfolio view
            function updatePortfolioView() {
                if (antiques.length === 0) {
                    emptyPortfolio.classList.remove('hidden');
                    portfolioContent.classList.add('hidden');
                    return;
                }
                
                emptyPortfolio.classList.add('hidden');
                portfolioContent.classList.remove('hidden');
                
                // Update statistics
                totalPieces.textContent = antiques.length;
                
                // Calculate total value (using average of min/max for each piece)
                let totalValueNum = 0;
                let maxValue = 0;
                let maxValueTitle = '';
                
                antiques.forEach(item => {
                    const avgValue = (item.valueRange.min + item.valueRange.max) / 2;
                    totalValueNum += avgValue;
                    
                    if (avgValue > maxValue) {
                        maxValue = avgValue;
                        maxValueTitle = item.title;
                    }
                });
                
                totalValue.textContent = `€${Math.round(totalValueNum).toLocaleString()}`;
                mostValuable.textContent = `€${Math.round(maxValue).toLocaleString()}`;
                
                // Update portfolio items
                portfolioItems.innerHTML = '';
                
                antiques.forEach(item => {
                    const avgValue = Math.round((item.valueRange.min + item.valueRange.max) / 2);
                    const itemEl = document.createElement('div');
                    itemEl.className = 'portfolio-item bg-white rounded-lg overflow-hidden shadow-lg';
                    itemEl.innerHTML = `
                        <div class="portfolio-item-image">
                            <img src="${item.image}" alt="${item.title}">
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold mb-2">${item.title}</h3>
                            <p class="text-sm text-gray-600 mb-3">${item.description}</p>
                            <div class="flex justify-between items-center text-sm text-gray-500 mb-3">
                                <span><i class="fas fa-palette mr-1"></i> ${item.style}</span>
                                <span><i class="fas fa-clock mr-1"></i> ${item.period}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg text-primary">€${avgValue.toLocaleString()}</span>
                                <button class="delete-item-btn text-red-500 hover:text-red-700" data-id="${item.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add delete event listener
                    itemEl.querySelector('.delete-item-btn').addEventListener('click', () => {
                        if (confirm('¿Estás seguro de que deseas eliminar esta pieza del portfolio?')) {
                            antiques = antiques.filter(a => a.id !== item.id);
                            localStorage.setItem('antiques', JSON.stringify(antiques));
                            updatePortfolioView();
                        }
                    });
                    
                    portfolioItems.appendChild(itemEl);
                });
            }

            // Export portfolio data
            function exportData() {
                if (antiques.length === 0) {
                    alert('No hay datos para exportar. Primero debes analizar y guardar alguna antigüedad.');
                    return;
                }
                
                // Create a JSON file
                const dataStr = JSON.stringify(antiques);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                // Create a download link
                const exportFileDefaultName = `santa_emilia_portfolio_${new Date().toISOString().slice(0, 10)}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            }

            // Import portfolio data
            function importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            // Ask user if they want to merge or replace
                            const action = confirm('¿Deseas reemplazar tu portfolio actual (OK) o añadir los nuevos elementos a tu portfolio existente (Cancelar)?');
                            
                            if (action) {
                                // Replace
                                antiques = importedData;
                            } else {
                                // Merge (avoiding duplicates by ID)
                                const existingIds = antiques.map(a => a.id);
                                const newItems = importedData.filter(a => !existingIds.includes(a.id));
                                antiques = [...antiques, ...newItems];
                            }
                            
                            localStorage.setItem('antiques', JSON.stringify(antiques));
                            updatePortfolioView();
                            alert('Datos importados exitosamente.');
                        } else {
                            alert('El archivo no contiene un formato válido de portfolio.');
                        }
                    } catch (error) {
                        console.error('Error al importar:', error);
                        alert('Error al importar el archivo: ' + error.message);
                    }
                };
                reader.readAsText(file);
                
                // Reset the input
                e.target.value = '';
            }

            // Clear portfolio
            function clearPortfolio() {
                if (antiques.length === 0) {
                    alert('El portfolio ya está vacío.');
                    return;
                }
                
                if (confirm('¿Estás seguro de que deseas eliminar TODAS las antigüedades de tu portfolio? Esta acción no se puede deshacer.')) {
                    antiques = [];
                    localStorage.setItem('antiques', JSON.stringify(antiques));
                    updatePortfolioView();
                    alert('Portfolio limpiado exitosamente.');
                }
            }

            // Reset all data
            function resetAll() {
                if (confirm('¿Estás seguro de que deseas restablecer TODA la configuración y datos? Se eliminarán las API keys y el portfolio completo. Esta acción no se puede deshacer.')) {
                    localStorage.removeItem('openai_api_key');
                    localStorage.removeItem('perplexity_api_key');
                    localStorage.removeItem('antiques');
                    alert('Todos los datos han sido restablecidos. La página se recargará.');
                    window.location.reload();
                }
            }
        });
    </script>
</body>
</html>
